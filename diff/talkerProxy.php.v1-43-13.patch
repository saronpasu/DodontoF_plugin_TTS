*** talkerProxy.org.php	2012-11-23 16:19:27.000000000 +0900
--- talkerProxy.php	2014-03-11 13:50:45.439029000 +0900
***************
*** 1,16 ****
! <?php
! $queryText = (isset($_POST['queryText']) && $_POST['queryText']) ? $_POST['queryText'] : 'undefined';
! $url = "http://translate.google.com/translate_tts?tl=ja&q=" . $queryText;
! 
! $option = array(
!     'http'=>array(
!         'method'=>"GET",
!         'header' => "User-Agent:Mozilla/5.5\r\n". //Mozilla‚ðŽw’è
!                     "Content-type: application/x-www-form-urlencoded\r\n".
!                     "Accept-Language: ja-jp,en;q=0.5\r\n".
!                     "Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7" ));
! $context = stream_context_create($option);
! $fp = fopen($url, 'r', false, $context);
! fpassthru($fp);
! fclose($fp);
! ?>
--- 1,93 ----
! <?php
! 
! date_default_timezone_set('Asia/Tokyo');
! mb_internal_encoding("UTF-8");
! mb_regex_encoding('UTF-8');
! 
! $queryText = (isset($_POST['queryText']) && $_POST['queryText']) ? $_POST['queryText'] : 'undefined';
! 
! $url_replaced = $queryText;
! 
! if($url_replaced == 'undefined'){ print ''; exit; }
! 
! $url_replaced_decoded = urldecode($url_replaced);
! 
! // å›ºæœ‰åè©žç½®æ›
! // Elysioné–¢é€£
! $url_replaced_decoded = preg_replace('/elysion/i',' ãˆã‚Šã‚…ã—ãŠã‚“ ',$url_replaced_decoded);
! 
! $url_replaced_decoded = preg_replace('/ã€Œ/ui','ãƒ»',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/ã€/ui','ãƒ»',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/^ï¼š(\d+) \((\d+D%*\d+).*/',' ã ã„ã™ã‚ãƒ¼ã‚‹ãƒ»$2ãƒ»åˆè¨ˆãƒ»$1 ',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/^ï¼š+/ui','',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/([^a-zA-Zï½-ï½šï¼¡-ï¼º])[wï½—]+$/ui','$1ãƒ»ã‚ã‚‰ ',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/([^a-zA-Zï½-ï½šï¼¡-ï¼º])[wï½—]{2,}/ui','$1ãƒ»',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/[\.ã€‚ï¼Žãƒ»â€¦]{2,}/ui','ãƒ»',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/â€¦/ui','ãƒ»',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/(ftp|http|https)\:\/\/.*/ui','ãƒ»$1ã®urlã§ã™ãƒ»',$url_replaced_decoded);
! 
! // è¾žæ›¸ç³»
! $url_replaced_decoded = preg_replace('/â†‘/ui','ãƒ»ã†ãˆãƒ»',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/â†“/ui','ãƒ»ã—ãŸãƒ»',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/â†/ui','ãƒ»ã²ã ã‚Šãƒ»',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/â†’/ui','ãƒ»ã¿ãŽãƒ»',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/æ¬ ç‰‡/ui','ã‹ã‘ã‚‰',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/SANãƒã‚§ãƒƒã‚¯/ui','ã•ã‚“ã¡ã‡ã£ã',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/ï¼³ï¼¡ï¼®ãƒã‚§ãƒƒã‚¯/ui','ã•ã‚“ã¡ã‡ã£ã',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/ç™¾åˆå±•é–‹/ui','ãã¾ã—ãŸã‚ãƒ¼',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/ç™¾åˆ/ui','ã‚†ã‚Š',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/ktkr/ui','ããŸã“ã‚Œ',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/ï½‹ï½”ï½‹ï½’/ui','ããŸã“ã‚Œ',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/ksk/ui','ã‹ãã',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/ï½‹ï½“ï½‹/ui','ã‹ãã',$url_replaced_decoded);
! $url_replaced_decoded = preg_replace('/æ™¶çŸ³/ui','ã—ã‚‡ã†ã›ã',$url_replaced_decoded);
! 
! 
! #/* === Open JTalk ã‚’ä½¿ã†å ´åˆ ===
! 
! // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‹ã‚’æ ¼ç´ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
! $voice_dir = "sound/tts/";
! 
! // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆã€ãã‚Œã‚’å…ƒã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å‘½åã€‚
! $uid = uniqid();
! $input_file = $uid . ".txt";
! $output_file = $uid . ".wav";
! 
! // èª­ã¿ä¸Šã’ç”¨ã«ã‚¯ã‚¨ãƒªå†…å®¹ã‚’ä¸€æ™‚çš„ã«ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¸å‡ºåŠ›
! $fp = fopen($voice_dir . $input_file, 'w+');
! fwrite($fp, $url_replaced_decoded);
! fclose($fp);
! 
! // ãƒªãƒ•ã‚¡ãƒ©ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã‚’å–å¾—ã—ã¦ã€tts.rb(TTSå°‚ç”¨ã®CGI)ã®ç›¸å¯¾ãƒ‘ã‚¹ã‚’å–å¾—ã™ã‚‹ã€‚
! $referer = $_SERVER["HTTP_REFERER"];
! $url = preg_replace("/DodontoF\.swf/", "tts.rb", $referer);
! 
! $url = $url."?uid=".$uid;
! 
! // === ã“ã“ã¾ã§ Open Jtalk ã‚’ä½¿ã†å ´åˆ ===
! #*/
! 
! /* ==== Google TTS ã‚’ä½¿ã†å ´åˆ ===
! // é€šå¸¸å–å¾—
! $url_replaced_reencoded = urlencode($url_replaced_decoded);
! $url = 'http://translate.google.com/translate_tts?tl=ja&q='.$url_replaced_reencoded;
! 
! // === ã“ã“ã¾ã§ Google TTS ã‚’ä½¿ã†å ´åˆ ===
! */
! 
! //GoogleTTS Open JTalkå…±é€šå‡¦ç†ã€‚
! $option = array(
!    	'http'=>array(
!        	'method'=>"GET",
!        	'header' => "User-Agent:Mozilla/5.5\r\n". //Mozillaã‚’æŒ‡å®š
!                    	"Content-type: application/x-www-form-urlencoded\r\n".
!                    	"Accept-Language: ja-jp,en;q=0.5\r\n".
!                    	"Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7" ));
! 
! //print "$url\n";
! $context = stream_context_create($option);
! $fp = fopen($url, 'r', false, $context);
! fpassthru($fp);
! fclose($fp);
! 
! ?>
